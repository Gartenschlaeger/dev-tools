<app-page-header title="{{ pageTitle }}"></app-page-header>

<form [formGroup]="form" (submit)="handleSubmit()">
	<!-- image -->
	<app-form-section title="Image">
		<div class="flex gap-1">
			<div class="flex-1">
				<app-form-textfield label="Image name" formControlName="imageName"></app-form-textfield>
			</div>
			<div class="flex-1">
				<app-form-textfield label="Image tag" formControlName="imageTag"></app-form-textfield>
			</div>
		</div>
	</app-form-section>

	<!-- container -->
	<app-form-section title="Container">
		<div class="mb-3">
			<app-form-textfield formControlName="containerName" label="Name"></app-form-textfield>
			<app-form-checkbox formControlName="runDettached">Dettached</app-form-checkbox>
		</div>

		<div>
			<app-form-label for="restartMode">Restart mode</app-form-label>
			<select name="restartMode" id="restartMode" class="form-input w-full" formControlName="restartMode">
				<option>no</option>
				<option>always</option>
				<option>unless-stopped</option>
			</select>
		</div>
	</app-form-section>

	<app-form-section title="Settings">
		<app-tab-control>
			<app-tab label="Network">
				<!-- network -->
				<div class="mb-3">
					<app-form-label for="networkMode">Mode</app-form-label>
					<select name="networkMode" id="networkMode" class="form-input w-full" formControlName="networkMode">
						<option>none</option>
						<option>bridge</option>
						<option>host</option>
						<option>custom</option>
					</select>
				</div>

				<div class="mb-3" *ngIf="form.get('networkMode')?.value === 'custom'">
					<app-form-textfield
						formControlName="networkName"
						placeholder="Custom network name"
					></app-form-textfield>
					<app-form-field-errors [control]="form"></app-form-field-errors>
				</div>

				<div class="mb-3">
					<app-form-textfield formControlName="hostname" label="Hostname"></app-form-textfield>
				</div>

				<form [formGroup]="formAddPortMapping" (submit)="handleAddPortMapping()">
					<app-form-label>Port mappings</app-form-label>
					<div class="flex items-stretch gap-1">
						<div class="flex-1">
							<app-form-textfield
								#inputContainerPort
								formControlName="containerPort"
								placeholder="Container port"
							></app-form-textfield>
						</div>
						<div class="flex-1">
							<app-form-textfield formControlName="hostPort" placeholder="Host port"></app-form-textfield>
						</div>

						<div class="flex-none">
							<button type="submit" class="btn btn-primary">
								<svg-plus-icon size="sm"></svg-plus-icon>
							</button>
						</div>
					</div>
				</form>

				<div formArrayName="portMappings" class="mt-1 space-y-1" *ngIf="portMappings.length">
					<div class="flex items-center gap-1" *ngFor="let c of portMappings.controls; index as i">
						<ng-container [formGroupName]="i">
							<div class="flex-1">
								<app-form-textfield
									formControlName="containerPort"
									placeholder="Container port"
								></app-form-textfield>
							</div>
							<div class="flex-1">
								<app-form-textfield
									formControlName="hostPort"
									placeholder="Host port"
								></app-form-textfield>
							</div>
							<button type="button" class="btn btn-danger" (click)="handleRemPortMapping(i)">
								<svg-delete-icon size="sm"></svg-delete-icon>
							</button>
						</ng-container>
					</div>
				</div>
			</app-tab>
			<app-tab label="Environment">
				<!-- environment -->
				<form [formGroup]="formAddEnvVariable" (submit)="handleAddEnvironment()">
					<app-form-label>Environment variables</app-form-label>
					<div class="flex items-stretch gap-1">
						<div class="flex-1">
							<input
								#inputEnvironmentKey
								type="text"
								class="form-input w-full"
								formControlName="key"
								placeholder="Key"
							/>
							<app-form-field-errors [control]="formAddEnvVariable.get('key')"></app-form-field-errors>
						</div>
						<div class="flex-1">
							<input type="text" class="form-input w-full" formControlName="value" placeholder="Value" />
							<app-form-field-errors [control]="formAddEnvVariable.get('value')"></app-form-field-errors>
						</div>
						<div class="flex-none">
							<button type="submit" class="btn btn-primary">
								<svg-plus-icon size="sm"></svg-plus-icon>
							</button>
						</div>
					</div>
				</form>

				<div formArrayName="environmentVariables" class="mt-1 space-y-1" *ngIf="environmentVariables.length">
					<div class="flex items-center gap-1" *ngFor="let c of environmentVariables.controls; index as i">
						<ng-container [formGroupName]="i">
							<input type="text" class="form-input flex-1" formControlName="key" placeholder="Key" />
							<input type="text" class="form-input flex-1" formControlName="value" placeholder="Value" />
							<button type="button" class="btn btn-danger" (click)="handleRemPortMapping(i)">
								<svg-delete-icon size="sm"></svg-delete-icon>
							</button>
						</ng-container>
					</div>
				</div>
			</app-tab>

			<app-tab label="Volumes">
				<!-- volume mappings -->
				<form [formGroup]="formAddVolumeMapping" (submit)="handleAddVolumeMapping()">
					<app-form-label>Volume mappings</app-form-label>
					<div class="flex items-stretch gap-1">
						<div class="flex-1">
							<input
								#inputVolumeHostPath
								type="text"
								class="form-input w-full"
								formControlName="hostPath"
								placeholder="Host path"
							/>
							<app-form-field-errors
								[control]="formAddVolumeMapping.get('hostPath')"
							></app-form-field-errors>
						</div>
						<div class="flex-1">
							<input
								type="text"
								class="form-input w-full"
								formControlName="containerPath"
								placeholder="Container path"
							/>
							<app-form-field-errors
								[control]="formAddVolumeMapping.get('containerPath')"
							></app-form-field-errors>
						</div>
						<div class="flex-none">
							<button type="submit" class="btn btn-primary">
								<svg-plus-icon size="sm"></svg-plus-icon>
							</button>
						</div>
					</div>
				</form>

				<div formArrayName="volumeMappings" class="mt-1 space-y-1" *ngIf="volumeMappings.length">
					<div class="flex items-center gap-1" *ngFor="let c of volumeMappings.controls; index as i">
						<ng-container [formGroupName]="i">
							<input
								type="text"
								class="form-input flex-1"
								formControlName="hostPath"
								placeholder="Host path"
							/>
							<input
								type="text"
								class="form-input flex-1"
								formControlName="containerPath"
								placeholder="Container path"
							/>
							<button type="button" class="btn btn-danger" (click)="handleRemoveVolumeMapping(i)">
								<svg-delete-icon size="sm"></svg-delete-icon>
							</button>
						</ng-container>
					</div>
				</div>
			</app-tab>
		</app-tab-control>
	</app-form-section>

	<!-- script -->
	<app-form-section title="Script">
		<div [ngClass]="{ 'mb-3': generatedScript }">
			<div class="space-y-1">
				<app-form-checkbox formControlName="useShortParams">Short parameter names</app-form-checkbox>
				<app-form-checkbox formControlName="multilineScript">Multiline script</app-form-checkbox>
			</div>
		</div>

		<div *ngIf="generatedScript">
			<app-highlighted-code [language]="'bash'" [code]="generatedScript"></app-highlighted-code>
		</div>
	</app-form-section>

	<app-form-section title="Share" *ngIf="shareLink">
		<app-code>{{ shareLink }}</app-code>
	</app-form-section>

	<app-form-footer>
		<div class="flex justify-between">
			<div>
				<button
					type="button"
					class="btn btn-primary"
					[attr.disabled]="generatedScript ? null : 'disabled'"
					(click)="handleShare()"
				>
					Share
				</button>
			</div>
			<div class="space-x-1">
				<button type="button" class="btn btn-secondary" (click)="handleReset()">Reset</button>
				<button type="submit" class="btn btn-primary">Generate</button>
			</div>
		</div>
	</app-form-footer>
</form>
